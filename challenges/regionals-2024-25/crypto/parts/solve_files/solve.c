// gcc solve.c -o solve -lgmp && ./solve

#include <stdio.h>
#include <stdlib.h>
#include <gmp.h>

#define PRINTABLE_CHAR_COUNT 95
const char* PRINTABLE_CHARS = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~ ";

#define CT_COUNT 23

int main()
{
    // Initialize parameters

    unsigned long int e = 65537;

    mpz_t n;
    mpz_init(n);
    mpz_set_str(n, "129188764973868707864770736177471107876487158035886844731538044191358383480443858654931305408247655967312211127935963074884444629300271383546207583975928023710403014302957303471768382855545942309377643623957507465446856649361655072910341876465023123798730372677831976338830883873611866793894401881589343775251", 10);

    mpz_t ct[CT_COUNT];
    const char* ct_str[CT_COUNT];

    ct_str[0] = "57161731618375166377653170640412672416455711429270252268625292976102447485222717066509315322132210512622383461153075582234230107558301863257074089930999420793664828666191937894660967895253338617132321975095006204511202985363536862860319490224450319648640020335562846250523110928763166211973461459200210561508";
    ct_str[1] = "52282904109128160619921955698653444296100584871011695670558893340353242273303615305558046930284711705772811883927806987230548090426212685545501626682120263411396698640674231099272682511315628659487952331088925271001446356174740575584739601303002116872289753012601355938723616277639340708793916929275992757858";
    ct_str[2] = "57152148643975820547504691259106856248019230519708779953130749180221465730549934621176299146372203129638571957417039831661819658127768565853265431736261278885958127055922051675341904501780282260159129548433179919905651991538949665798433184785725794683459717217219784984312186547771696187855679362823616903673";
    ct_str[3] = "31014162528093200054056556872703736797712001870832747095050879917657612065172713349221727348827598690495554777988292249014543701980165071784254559910706950003899825905183433123543757455145344286407661629757366425955490539700536490999279048287656612880426994375125865174811897553732817009073366041261606567050";
    ct_str[4] = "82726003862724851464926784028707038924678810589538432328795870605251646978561157469292392437739083650680691359369050494191502598402940768564500290097740819966804440095261680710118478791849052928044038256175292521965519890958452266651166679774122765735504427492930106745013676398555149545138764484568260824030";
    ct_str[5] = "26126660140204468052761415806526648085526958491564293015908869962278605874517304308048507622791422188315753639697716379462123951203471632063170508684286422370931373114275593928465835280698493901852970451852852984400219717830394268848260203245082464202290824276073192822263527456400374645650523863826036313812";
    ct_str[6] = "76920017006711763257468183879405052561057689723898907023946619927118526321345855586779062840468483427501794634238692370009451886703429995414822291477105415851280401011710344483647376264018328770503608819883586750211584023246468342162143248301236849064282569144151423498550698172028870834812948691717610460112";
    ct_str[7] = "114651902099337028611627032290900770889544779267978658206981903054346968371562940484416276098514739503122418084074448483210585445002770130952442209516595231242765850345533961657682330478159168114226136857026896051240014221239920081353356495114441584208902897256443482807273762633623584457683314292700436948106";
    ct_str[8] = "32697844382359021316850224297656127439339116969025362516339084269219626924813323501043296591487811104308844771832322301531716285827640613657904598912815399014084525407240678496757686522337013808410146656569764579003388801809751945117432011199208946911044605419029544008944908828369980868985921203042067815993";
    ct_str[9] = "31448462645057996158527806957738849029736681407788410660911114911302711972632254321195805062207482777577677087651286841830189511429142287786972389867897707294355791264404337028315904979515988154328453672970642697170726993297391568659537208562315286817508655997644575423749791152356744879018140135170195362041";
    ct_str[10] = "115977945039237589563940484573582993606130683465961834213938064357514265863776346385773404158908750666460827042128301951506348028592671626220139953439731266071572529793198961984170533390307285520522167847584801115888700629255508745861899300348691175585678955599469544521932565265398940768862209139366225584937";
    ct_str[11] = "7343555121716635726106826503305011525221792633393142407881430099132790107114705856977933483011320589407493309130322059044089580985449086368581038407559628658214140766474396006289098772140056460782296786508270827837494528420404019036471065647034450152772135637573635577192014704678089878639440604735404062678";
    ct_str[12] = "17458763615495247335917723168132312672922971837519731911561796300828027684348021047637750466188551886866388209109873695320266918480240820398268593963731356523697971223786362330553469784536003932046769769617799103246207413185468175486135985232163407997125329709038603706895210816476460872169153238450703381423";
    ct_str[13] = "22619086296137020630313416352090073562512863718970219664112884707141933466648471409542253426002920318800389794410917613618034900551618024356605460175614306359546024916775068960006016152176852644764168308673688942913715613729811195294989782220176908382454523791586741979439930849432673178216217220021022069099";
    ct_str[14] = "81105101436892464042334861747957148623647885080655533265317156314563725184619792168610157176312361502314445334718879431084319895874035503278076754542676100695058891420513283400050379433809413518090299690278936031769359990210987463612635791260992848870586281527481873778354611079935998341818848367638579407064";
    ct_str[15] = "50503971518111680039465543346013957554795314651319576508372668393455540131970868348799344277309943553606084778236092225028981668791057897217400146663173068118954962121270971225687188553025414954752153448607657750435279469206781480109686680017815593291694791916133655286976815110293925816118123527589508199952";
    ct_str[16] = "120742178782748495741413197644148039351982643239391267874861365587920396486992488955755730123702293718760443314606335489488521673888246183194551969142197637944821733918924196823341338183423777074999431931999963693321147722193275553262901239788451891202260077200759277950974159520168425731903678841189471583264";
    ct_str[17] = "32339084982484907469518429216441415747913124689444635480262096471945072305292617661457239269161490980178099492485044168461632528730358454458961123471301123223944945776935792919493240703649552710092797661077165468289689864389870054589301923064269030231431510273222982558420327308426491477388376506253531060218";
    ct_str[18] = "52401859514239389661316873358781204809934249684340730977205832257331743100550115050549420153308295480454123120419061264034725999705870982135814582198718506206779741635320349483410417249664322099521691359920080493485619370050030567302397792695547074729167737216356860793511182830643851657451254575027693829603";
    ct_str[19] = "32971454695482541388621766287922881015711296235424642454780477257130105922756854956440763688676509235619014807408084521296079572184846165923194127060978289587192322366720149389322936175221635584615605794834241680528924889201572714216354059663002362825550874270351168748949683176825275019317468844864026833920";
    ct_str[20] = "94548780254003859553683162104827360036818697951541474675186613317456891505725469071596693218727130391295843160377978042853509642840692106713852670250970319474382641425553042543730562890457721477070522100796160477343776717204258576666020896142031263494368800095251264156994384970067912441912932618767614411915";
    ct_str[21] = "60491611219114688852570799302042011487142079338082303011102416443011597481969369926518059200730429283106805788655430571195171337173049858052595106661134618586416511229655890502629793942581746519991159107376711169710749626252935091577596899334730184240674248972841327870369650902145900588315981806059229166172";
    ct_str[22] = "118657887982828964504228138052473613713536489470880421299847433061337608001851421164815195938743609279463926672441814259477516653229715996984413251798279094745309481126525017075459692595212578460567055020462303967549342652820211374756793326344637772529989363047555683589529866554193749689462726382226850714750";

    for (int i = 0; i < CT_COUNT; i++)
    {
        mpz_init(ct[i]);
        mpz_set_str(ct[i], ct_str[i], 10);
    }

    // Bruteforce plaintext blocks

    char pt_str[CT_COUNT*4+1];
    for (int i = 0; i < CT_COUNT*4; i++)
    {
        pt_str[i] = ' ';
    }
    pt_str[CT_COUNT*4] = '\0';

    unsigned long pt_block;
    mpz_t mpz_pt_block;
    mpz_init(mpz_pt_block);
    
    mpz_t ct_block;
    mpz_init(ct_block);

    float progress = 0.0f;

    for (int a = 0; a < PRINTABLE_CHAR_COUNT; a++)
    {
        // Calculate and print progress
        progress = (float)a / PRINTABLE_CHAR_COUNT * 100;
        printf("Progress: %.2f%%\n", progress);

        for (int b = 0; b < PRINTABLE_CHAR_COUNT; b++)
        {
            for (int c = 0; c < PRINTABLE_CHAR_COUNT; c++)
            {
                for (int d = 0; d < PRINTABLE_CHAR_COUNT; d++)
                {
                    // craft plaintext block
                    pt_block = (PRINTABLE_CHARS[a] << 24) | (PRINTABLE_CHARS[b] << 16) | (PRINTABLE_CHARS[c] << 8) | PRINTABLE_CHARS[d];
                    mpz_set_ui(mpz_pt_block, pt_block);

                    // encrypt plaintext block
                    mpz_powm_ui(ct_block, mpz_pt_block, e, n);

                    // compare with known ciphertext blocks
                    for (int i = 0; i < CT_COUNT; i++)
                    {
                        if (mpz_cmp(ct_block, ct[i]) == 0)
                        {
                            printf("Found plaintext block for ct[%d]: %c%c%c%c\n", i, PRINTABLE_CHARS[a], PRINTABLE_CHARS[b], PRINTABLE_CHARS[c], PRINTABLE_CHARS[d]);
                            pt_str[i*4] = PRINTABLE_CHARS[a];
                            pt_str[i*4+1] = PRINTABLE_CHARS[b];
                            pt_str[i*4+2] = PRINTABLE_CHARS[c];
                            pt_str[i*4+3] = PRINTABLE_CHARS[d];
                        }
                    }
                }
            }
        }
    }

    printf("Plaintext: %s\n", pt_str);

    printf("Done.\n");

    return 0;
}